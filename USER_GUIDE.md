# tbcompare 用户指南

## 目录

1. [简介](#简介)
2. [安装](#安装)
3. [基本使用](#基本使用)
4. [高级功能](#高级功能)
5. [输出解释](#输出解释)
6. [常见问题](#常见问题)
7. [故障排除](#故障排除)
8. [最佳实践](#最佳实践)

## 简介

tbcompare 是一个专门用于比较投保基金导出文件的命令行工具。它能够识别和比较遵循特定命名约定的文件对，并报告它们之间的差异。

## 安装

### 使用 Cargo 安装

如果你已经安装了 Rust 和 Cargo，可以通过以下命令安装 tbcompare：

```bash
git clone https://github.com/rfiacne/tbcompare.git
cargo install --path .
```

## 基本使用

### 比较两个目录

最基本的用法是提供两个包含要比较文件的目录路径：

```bash
tbcompare /path/to/dir1 /path/to/dir2
```

在 Windows 上：
```cmd
tbcompare C:\path\to\dir1 C:\path\to\dir2
```

### 指定线程数

可以通过 `-t` 或 `--threads` 参数指定并行线程数：

```bash
tbcompare -t 8 /path/to/dir1 /path/to/dir2
```

### 指定输出文件

可以通过 `-o` 或 `--output` 参数指定报告输出文件：

```bash
tbcompare -o comparison_report.txt /path/to/dir1 /path/to/dir2
```

使用自定义报告名（会自动添加时间戳）：
```bash
tbcompare -o my_comparison /path/to/dir1 /path/to/dir2
```

## 高级功能

### 文件命名约定

tbcompare 专门设计用于处理遵循以下命名模式的文件：

```
SC_aaaaaaaa_yyyymmdd_tttN_AXX_Z[.ext]
```

其中：
- `SC`：固定前缀
- `aaaaaaaa`：8位数字标识符
- `yyyymmdd`：8位日期（年月日）
- `tttN`：版本号（可变长度数字后跟N）
- `AXX`：A后跟两位数字
- `Z`：固定后缀
- `[.ext]`：可选的文件扩展名

工具会匹配具有相同 `aaaaaaaa`、`yyyymmdd` 和 `AXX` 部分但不同 `tttN` 版本的文件对。

例如，以下文件对会被匹配：
- `SC_13260000_20190820_019N_A05_Z.txt` 和 `SC_13260000_20190820_020N_A05_Z.txt`

但以下文件不会被匹配：
- `SC_13260000_20190820_019N_A05_Z.txt` 和 `SC_13260001_20190820_019N_A05_Z.txt` (不同的 `aaaaaaaa`)
- `SC_13260000_20190820_019N_A05_Z.txt` 和 `SC_13260000_20190821_019N_A05_Z.txt` (不同的 `yyyymmdd`)
- `SC_13260000_20190820_019N_A05_Z.txt` 和 `SC_13260000_20190820_019N_A06_Z.txt` (不同的 `AXX`)

### 大文件处理

对于大文件（超过100MB），tbcompare 会自动使用外部排序来避免内存问题，确保即使处理大型文件也能保持稳定的性能。

### 编码检测

tbcompare 能够自动检测文件编码，支持多种字符编码格式，包括 UTF-8、GBK、GB2312 等。

## 输出解释

### 控制台输出

运行 tbcompare 后，控制台会显示以下信息：
- 找到的文件对数量
- 比较进度（通过进度条显示）
- 比较结果摘要（发现差异的文件对数量、比较出错的文件对数量、完全相同的文件对数量）

### 报告文件

tbcompare 会生成一个详细的文本报告文件，包含以下信息：
- 比较时间戳
- 比较的目录信息
- 文件对数量
- 每个有差异的文件对的详细信息
- 比较结果的统计摘要

报告文件默认命名为 `comparison_report_YYYYMMDD_HHMMSS.txt`，其中 YYYYMMDD_HHMMSS 是生成报告时的时间戳。

## 常见问题

### Q: 为什么我的文件没有被识别为匹配对？

A: 请确保文件遵循指定的命名约定。工具只会匹配具有相同 `aaaaaaaa`、`yyyymmdd` 和 `AXX` 部分但不同 `tttN` 版本的文件对。

### Q: 比较大文件时性能很慢怎么办？

A: tbcompare 默认使用4个线程进行并行处理。你可以通过 `-t` 参数增加线程数来提高性能，但不要超过系统CPU核心数。

### Q: 如何查看详细的比较结果？

A: 除了控制台输出的摘要信息外，tbcompare 还会生成一个详细的报告文件，其中包含每个有差异文件对的具体差异。

### Q: 为什么比较结果中显示文件相同但实际上有差异？

A: tbcompare 在比较时会跳过每个文件的第一行（通常为标题行），并对剩余行进行排序后再比较。如果两文件除了行的顺序外其他内容都相同，则会被认为是相同的文件。

## 故障排除

### 错误: "找不到匹配的文件对"

- 检查目录路径是否正确
- 确认文件是否遵循指定的命名约定
- 验证两个目录中是否存在匹配的文件对

### 错误: "无法读取文件"

- 检查文件权限
- 确认文件未被其他程序占用
- 验证文件是否损坏

### 错误: "编码检测失败"

- 尝试手动转换文件编码为 UTF-8
- 如果问题持续存在，请提交 issue 并附上文件样本

### 错误: "fc.exe 或 diff 命令执行失败"

- 这些是系统命令，如果执行失败，工具会自动回退到内置比较算法
- 如果在 Windows 上遇到此问题，请确保系统环境变量中包含 System32 目录

## 最佳实践

1. **文件组织**：将要比较的文件按目录组织，每个目录包含一个时间点的导出文件。

2. **命名规范**：严格遵循文件命名约定，确保 tbcompare 能正确识别文件对。

3. **定期比较**：建立定期比较机制，及时发现数据差异。

4. **报告保存**：妥善保存比较报告，用于后续分析和审计。

5. **性能优化**：根据系统配置调整线程数，获得最佳性能。对于4核CPU，建议使用4-8个线程。

6. **大文件处理**：对于超过100MB的大文件，tbcompare 会自动使用优化策略处理，无需特殊操作。